{% extends "shop/base.html" %}

{% block extra_head %}
<link rel="canonical" href="https://neboley.pythonanywhere.com{% url 'shop:product_detail' product.slug %}">
{% endblock %}

{% block title %}{{ product.name }} - –ú–∞–≥–∞–∑–∏–Ω —Ç–æ–≤–∞—Ä–æ–≤ NEBOLEY{% endblock %}
{% block header %}{{ product.name }}{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
    <div>
        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
        <img id="main-product-image" src="{% if product.image %}{{ product.image.url }}{% endif %}" 
             alt="{{ product.name }}" style="max-width: 100%; height: 400px; object-fit: cover; cursor: pointer;"
             onclick="zoomImage(this)">
        
        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
        {% if product_images %}
        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
            {% for image in product_images %}
            <img src="{{ image.image.url }}" alt="{{ image.alt_text }}" 
                 style="width: 80px; height: 80px; object-fit: cover; cursor: pointer; border: 2px solid {% if image.is_main %}#007bff{% else %}#ddd{% endif %};"
                 onclick="changeMainImage(this, '{{ image.image.url }}', '{{ image.alt_text }}')"
                 data-image-id="{{ image.id }}"
                 class="thumbnail">
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <div>
        <h2>{{ product.name }}</h2>
        <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ product.category.name }}</p>
        
        <div style="font-size: 1.5em; margin: 20px 0;">
            {% if product.old_price %}
                <span style="text-decoration: line-through; color: #999; margin-right: 15px;">
                    {{ product.get_old_price_display }}
                </span>
            {% endif %}
            <span style="color: #e74c3c; font-weight: bold;">{{ product.get_price_display }}</span>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–º–µ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É -->
        <form method="post" action="{% url 'shop:add_to_cart' %}" style="margin: 20px 0;">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">
            
            <!-- –ë–ª–æ–∫ —Å –Ω–∞–ª–∏—á–∏–µ–º –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º –∏ –≤—ã–±–æ—Ä–æ–º -->
            <div style="margin: 20px 0;">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä:</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                    {% for product_size in all_sizes %}
                    <div style="border: 2px solid {% if product_size.in_stock %}#28a745{% else %}#dc3545{% endif %}; 
                               padding: 15px; border-radius: 8px; text-align: center;
                               background: {% if product_size.in_stock %}#f8fff8{% else %}#fff5f5{% endif %};
                               transition: all 0.3s ease;"
                         class="size-block">
                        
                        <!-- –†–∞–∑–º–µ—Ä -->
                        <div style="font-weight: bold; margin-bottom: 8px; font-size: 1.1em;">
                            {{ product_size.size.name }}
                        </div>
                        
                        <!-- –ù–∞–ª–∏—á–∏–µ -->
                        <div style="font-size: 1.1em; color: {% if product_size.in_stock %}#28a745{% else %}#dc3545{% endif %}; margin-bottom: 10px;">
                            {% if product_size.in_stock %}
                                ‚úÖ {{ product_size.stock_quantity }} —à—Ç.
                            {% else %}
                                ‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                            {% endif %}
                        </div>
                        
                        <!-- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è) -->
                        {% if product_size.price and product_size.price != product.price %}
                        <div style="font-size: 1em; color: #e74c3c; margin-bottom: 10px; font-weight: bold;">
                            {{ product_size.get_price_display }}
                        </div>
                        {% endif %}
                        
                        <!-- –†–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–º–µ—Ä–∞ -->
                        <label style="display: block; cursor: {% if product_size.in_stock %}pointer{% else %}not-allowed{% endif %};">
                            <input type="radio" name="size_id" value="{{ product_size.id }}"
                                   {% if not product_size.in_stock %}disabled{% endif %}
                                   style="margin-right: 5px;"
                                   {% if forloop.first and product_size.in_stock %}checked{% endif %}>
                            <span style="{% if not product_size.in_stock %}opacity: 0.6;{% endif %}">
                                {% if product_size.in_stock %}–í—ã–±—Ä–∞—Ç—å{% else %}–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ{% endif %}
                            </span>
                        </label>
                    </div>
                    {% empty %}
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px;">
                        <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
            <div style="display: flex; align-items: center; gap: 20px; margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <div>
                    <label for="quantity" style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 1.1em;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" max="10" 
                           style="padding: 12px; width: 100px; border: 2px solid #ddd; border-radius: 5px; font-size: 1.1em;">
                </div>
                
                <div>
                    <button type="submit" 
                            style="background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 8px; 
                                   font-size: 1.2em; cursor: pointer; transition: all 0.3s ease;"
                            id="add-to-cart-btn"
                            onmouseover="this.style.transform='scale(1.05)'"
                            onmouseout="this.style.transform='scale(1)'">
                        üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
                    </button>
                </div>
            </div>
        </form>

        <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
        {% if product.description %}
        <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h3 style="margin-bottom: 15px;">–û–ø–∏—Å–∞–Ω–∏–µ:</h3>
            <p style="line-height: 1.6; color: #555;">{{ product.description }}</p>
        </div>
        {% endif %}

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç–µ -->
        <div style="background: #e7f3ff; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h4 style="margin-bottom: 10px; color: #0066cc;">üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ:</h4>
            <ul style="margin: 0; padding-left: 20px; color: #555;">
                <li>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç 3000 ‚ÇΩ</li>
                <li>–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –†–æ—Å—Å–∏–∏ 2-7 –¥–Ω–µ–π</li>
                <li>–í–æ–∑–≤—Ä–∞—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π</li>
            </ul>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<div id="image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center;">
    <img id="zoomed-image" src="" alt="" style="max-width: 90%; max-height: 90%;">
    <button onclick="closeZoom()" style="position: absolute; top: 20px; right: 20px; background: #fff; color: #000; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const addButton = document.getElementById('add-to-cart-btn');
    const sizeInputs = document.querySelectorAll('input[name="size_id"]');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    const availableSizes = Array.from(sizeInputs).filter(input => !input.disabled);
    
    if (availableSizes.length === 0) {
        // –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ - –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π
        addButton.disabled = true;
        addButton.style.background = '#6c757d';
        addButton.textContent = '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
        addButton.style.cursor = 'not-allowed';
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞
    sizeInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.disabled) {
                addButton.disabled = true;
                addButton.style.background = '#6c757d';
                addButton.textContent = '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                addButton.style.cursor = 'not-allowed';
            } else {
                addButton.disabled = false;
                addButton.style.background = '#28a745';
                addButton.textContent = 'üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É';
                addButton.style.cursor = 'pointer';
            }
        });
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', function(e) {
        const selectedSize = document.querySelector('input[name="size_id"]:checked');
        
        if (!selectedSize || selectedSize.disabled) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ä–∞–∑–º–µ—Ä');
            return false;
        }
        
        const quantity = document.getElementById('quantity').value;
        if (quantity < 1 || quantity > 10) {
            e.preventDefault();
            alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 10');
            return false;
        }
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function changeMainImage(thumbnailElement, imageUrl, altText) {
    const mainImage = document.getElementById('main-product-image');
    mainImage.src = imageUrl;
    mainImage.alt = altText;
    
    const allThumbnails = document.querySelectorAll('.thumbnail');
    allThumbnails.forEach(thumb => {
        thumb.style.borderColor = '#ddd';
    });
    
    thumbnailElement.style.borderColor = '#007bff';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function zoomImage(imageElement) {
    const modal = document.getElementById('image-modal');
    const zoomedImg = document.getElementById('zoomed-image');
    
    zoomedImg.src = imageElement.src;
    zoomedImg.alt = imageElement.alt;
    modal.style.display = 'flex';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function closeZoom() {
    document.getElementById('image-modal').style.display = 'none';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
document.getElementById('image-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeZoom();
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeZoom();
    }
});
</script>

<style>
.thumbnail {
    transition: all 0.3s ease;
}
.thumbnail:hover {
    transform: scale(1.1);
    border-color: #007bff !important;
}
#main-product-image {
    transition: all 0.3s ease;
}
#main-product-image:hover {
    opacity: 0.9;
}
.size-block:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
</style>

{% if related_products %}
<div style="margin-top: 40px;">
    <h3>–°–º–æ—Ç—Ä–∏—Ç–µ —Ç–∞–∫–∂–µ:</h3>
    <div class="product-grid">
        {% for product in related_products %}
        <div class="product-card">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
            {% endif %}
            <h4><a href="{% url 'shop:product_detail' product.slug %}">{{ product.name }}</a></h4>
            <div class="price">{{ product.get_price_display }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}